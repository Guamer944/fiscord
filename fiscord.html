<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- CHANGED: Title is now Fiscord -->
    <title>Fiscord</title>
    
    <!-- CHANGED: Icon is now Shrek -->
    <link rel="shortcut icon" href="https://upload.wikimedia.org/wikipedia/en/4/4d/Shrek_%28character%29.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #36393f;
            color: #dcddde;
            overflow: hidden;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: #2e3338; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 4px; }
        
        .discord-sidebar { background-color: #2f3136; }
        .discord-header { background-color: #36393f; border-bottom: 1px solid #202225; }
        .discord-user-panel { background-color: #292b2f; }
        .discord-input { background-color: #40444b; }
        
        .message-group:hover .message-actions { opacity: 1; }
        .message-actions { opacity: 0; transition: opacity 0.1s; }
        .message-hover:hover { background-color: #32353b; }
        
        /* Interactive States */
        .channel-item { transition: all 0.1s; }
        .channel-item:hover { background-color: #35373c; color: #dcddde; }
        .channel-item.active { background-color: #393c43; color: white; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5865f2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, limit, updateDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBX97qT9YjFOtxh4XRhyRDUTFmYZmUB6yA",
            authDomain: "fiscord-e3fb6.firebaseapp.com",
            projectId: "fiscord-e3fb6",
            storageBucket: "fiscord-e3fb6.firebasestorage.app",
            messagingSenderId: "940332702760",
            appId: "1:940332702760:web:95293d3d42615b0971291d",
            measurementId: "G-3M3XWHNGMR"
        }; 

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
        const TENOR_API_KEY = "AIzaSyDncbwoeJZCAx4kN4x9dF-gxcmm6MjaiOs";
        const TENOR_CLIENT_KEY = "DiscordCloneApp";

        // --- INIT ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Init Error", e); }

        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const STATUS_MAP = {
            online: { color: "bg-green-500", icon: "fas fa-circle" },
            idle: { color: "bg-yellow-500", icon: "fas fa-moon" },
            dnd: { color: "bg-red-500", icon: "fas fa-minus" },
            invisible: { color: "bg-gray-500", icon: "fas fa-eye-slash" }
        };

        const compressImage = (file, maxWidth = 800, quality = 0.7) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            });
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return "Sending...";
            const date = timestamp.toDate();
            const today = new Date();
            const isToday = date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
            return isToday ? `Today at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : `${date.toLocaleDateString()} at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        };

        // --- COMPONENTS ---

        function UserSettings({ user, currentUserData, onClose }) {
            const [name, setName] = useState(currentUserData.displayName || user.displayName || "");
            const [avatar, setAvatar] = useState(currentUserData.photoURL || user.photoURL || "");
            const [saving, setSaving] = useState(false);
            const fileRef = useRef(null);

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const base64 = await compressImage(file, 256, 0.6);
                    setAvatar(base64);
                }
            }

            const handleSave = async () => {
                setSaving(true);
                try {
                    if (name !== user.displayName) await updateProfile(auth.currentUser, { displayName: name });
                    await setDoc(doc(db, "users", user.uid), { displayName: name, photoURL: avatar, uid: user.uid }, { merge: true });
                    onClose();
                } catch (e) { console.error(e); }
                setSaving(false);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center">
                    <div className="bg-[#36393f] w-full max-w-md rounded-lg shadow-lg p-6 animate-fade-in">
                        <h2 className="text-2xl font-bold text-white mb-6">My Account</h2>
                        <div className="flex justify-center mb-6">
                            <div className="relative group cursor-pointer" onClick={() => fileRef.current.click()}>
                                <img src={avatar || "https://cdn.discordapp.com/embed/avatars/0.png"} className="w-24 h-24 rounded-full border-4 border-[#202225] object-cover" />
                                <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><span className="text-xs text-white font-bold">CHANGE</span></div>
                                <input type="file" ref={fileRef} onChange={handleFileChange} className="hidden" accept="image/png, image/jpeg, image/webp" />
                            </div>
                        </div>
                        <div className="mb-4">
                            <label className="text-xs font-bold text-gray-400 uppercase">Username</label>
                            <input className="w-full bg-[#202225] text-white p-2 rounded mt-1 focus:outline-none" value={name} onChange={e => setName(e.target.value)} />
                        </div>
                        <div className="flex justify-end space-x-2 mt-6">
                            <button onClick={onClose} className="px-4 py-2 hover:underline text-white">Cancel</button>
                            <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-[#5865f2] hover:bg-[#4752c4] text-white rounded">{saving ? "Saving..." : "Save Changes"}</button>
                        </div>
                    </div>
                </div>
            );
        }

        function StatusSetter({ currentStatus, onSelectStatus, onClose }) {
            return (
                <div className="absolute bottom-12 left-2 z-50 bg-[#1e1f22] p-2 rounded-lg shadow-2xl w-56 border border-[#202225]">
                    {Object.entries(STATUS_MAP).map(([key, {color, icon, label = key}]) => (
                        <div key={key} onClick={() => { onSelectStatus(key); onClose(); }} className="flex items-center p-2 rounded cursor-pointer hover:bg-[#393c43] capitalize text-gray-200">
                            <div className={`w-3 h-3 ${color} rounded-full flex items-center justify-center mr-3 relative`}><i className={`${icon} text-[8px] text-[#1e1f22] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2`}></i></div>
                            {key}
                        </div>
                    ))}
                </div>
            );
        }

        function GifPicker({ onSelect, close }) {
            const [gifs, setGifs] = useState([]);
            const [search, setSearch] = useState("");
            
            useEffect(() => { fetchGifs(""); }, []);
            
            const fetchGifs = async (q) => {
                const url = `https://tenor.googleapis.com/v2/${q ? 'search' : 'featured'}?key=${TENOR_API_KEY}&client_key=${TENOR_CLIENT_KEY}&limit=20${q ? '&q='+q : ''}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    setGifs(data.results || []);
                } catch (e) {}
            };

            return (
                <div className="absolute bottom-20 right-8 w-80 bg-[#2f3136] border border-[#202225] rounded-lg shadow-2xl z-50 flex flex-col h-96">
                    <div className="p-3 bg-[#202225] rounded-t-lg">
                        <input type="text" placeholder="Search Tenor..." className="w-full bg-[#40444b] text-white p-2 rounded text-sm focus:outline-none" 
                            value={search} onChange={(e) => setSearch(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && fetchGifs(search)} autoFocus />
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 grid grid-cols-2 gap-2 custom-scrollbar">
                        {gifs.map(g => <img key={g.id} src={g.media_formats.tinygif.url} className="w-full h-auto rounded cursor-pointer object-cover" onClick={() => onSelect(g.media_formats.gif.url)} />)}
                    </div>
                </div>
            );
        }

        function AuthScreen() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [username, setUsername] = useState(""); 
            const [error, setError] = useState("");

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        const defaultPic = `https://cdn.discordapp.com/embed/avatars/${Math.floor(Math.random()*5)}.png`;
                        await updateProfile(cred.user, { displayName: username, photoURL: defaultPic });
                        await setDoc(doc(db, "users", cred.user.uid), { uid: cred.user.uid, displayName: username, photoURL: defaultPic, status: "online" });
                    }
                } catch (err) { setError(err.message); }
            };

            return (
                <div className="flex items-center justify-center h-screen w-full bg-[url('https://wallpaperaccess.com/full/2650150.jpg')] bg-cover">
                    <div className="bg-[#36393f] p-8 rounded-lg shadow-2xl w-96">
                        <h2 className="text-2xl font-bold text-white text-center mb-2">{isLogin ? "Welcome Back!" : "Create Account"}</h2>
                        {error && <div className="text-red-500 text-sm mb-4 bg-red-500/10 p-2 rounded">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && <div><label className="block text-xs font-bold text-gray-400 uppercase">Username</label><input className="w-full bg-[#202225] text-white p-2 rounded focus:outline-none" required value={username} onChange={e => setUsername(e.target.value)} /></div>}
                            <div><label className="block text-xs font-bold text-gray-400 uppercase">Email</label><input type="email" className="w-full bg-[#202225] text-white p-2 rounded focus:outline-none" required value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-xs font-bold text-gray-400 uppercase">Password</label><input type="password" className="w-full bg-[#202225] text-white p-2 rounded focus:outline-none" required value={password} onChange={e => setPassword(e.target.value)} /></div>
                            <button className="w-full bg-[#5865f2] hover:bg-[#4752c4] text-white font-semibold p-2 rounded">{isLogin ? "Log In" : "Register"}</button>
                        </form>
                        <div className="mt-4 text-sm text-gray-400 text-center"><button onClick={() => setIsLogin(!isLogin)} className="text-[#00b0f4] hover:underline">{isLogin ? "Register" : "Log In"}</button></div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [messages, setMessages] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            
            // Channel State: 'global' or a specific DM ID
            const [activeChannelId, setActiveChannelId] = useState('global');
            
            const [newMessage, setNewMessage] = useState("");
            const [showGifPicker, setShowGifPicker] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showStatusSetter, setShowStatusSetter] = useState(false);
            const fileInputRef = useRef(null);
            const dummyEndRef = useRef(null);

            // Auth
            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                return () => unsub();
            }, []);

            // Users
            useEffect(() => {
                if(!user) return;
                const unsub = onSnapshot(collection(db, "users"), (snap) => setAllUsers(snap.docs.map(d => d.data())));
                return () => unsub();
            }, [user]);

            // Messages (Filtered by Channel)
            useEffect(() => {
                if (!db || !user) return;
                setMessages([]); // Clear on channel switch

                let q;
                if (activeChannelId === 'global') {
                    // Backwards compatibility: fetch messages where channelId is 'global' OR missing
                    q = query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(100));
                } else {
                    // Strict filter for DMs
                    q = query(collection(db, "messages"), where("channelId", "==", activeChannelId), orderBy("createdAt", "asc"), limit(100));
                }

                const unsub = onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    // Manual filter for old messages if in global
                    const filtered = activeChannelId === 'global' 
                        ? msgs.filter(m => !m.channelId || m.channelId === 'global')
                        : msgs;
                    setMessages(filtered);
                });
                return () => unsub();
            }, [user, activeChannelId]);

            useEffect(() => { dummyEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const currentUserData = allUsers.find(u => u.uid === user?.uid) || { status: 'online' };
            
            // Filter out ghost users
            const otherUsers = allUsers.filter(u => 
                u.uid !== user?.uid && 
                u.displayName && 
                u.displayName.trim() !== ""
            );

            // --- Logic to get unique DM ID ---
            const getDmId = (otherUid) => {
                const uids = [user.uid, otherUid].sort();
                return `${uids[0]}_${uids[1]}`;
            };

            const sendMessage = async (e, imgUrl = null) => {
                if(e) e.preventDefault();
                
                // --- CLEAR COMMAND ---
                if (newMessage === "/clear") {
                    if (!confirm("Are you sure you want to delete all messages in this channel?")) return;
                    let q;
                    if (activeChannelId === 'global') {
                        q = query(collection(db, "messages"), orderBy("createdAt", "asc")); 
                    } else {
                        q = query(collection(db, "messages"), where("channelId", "==", activeChannelId));
                    }
                    const snapshot = await getDocs(q);
                    snapshot.forEach((d) => { deleteDoc(doc(db, "messages", d.id)); });
                    setNewMessage("");
                    return;
                }

                if((!newMessage.trim() && !imgUrl) || !user) return;

                const payload = {
                    text: newMessage,
                    imageUrl: imgUrl,
                    createdAt: serverTimestamp(),
                    uid: user.uid,
                    displayName: currentUserData.displayName || user.displayName,
                    photoURL: currentUserData.photoURL || user.photoURL,
                    channelId: activeChannelId
                };
                
                setNewMessage("");
                await addDoc(collection(db, "messages"), payload);
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if(file) sendMessage(null, await compressImage(file));
            };

            const updateStatus = async (s) => setDoc(doc(db, "users", user.uid), { status: s }, { merge: true });

            if (loading) return <div className="h-screen bg-[#36393f] flex items-center justify-center"><div className="loader"></div></div>;
            if (!user) return <AuthScreen />;

            // Get Active Channel Name
            let channelName = "General";
            let channelIcon = "fas fa-hashtag";
            
            if (activeChannelId !== 'global') {
                // Find the other user in this DM
                const parts = activeChannelId.split('_');
                const otherId = parts.find(id => id !== user.uid);
                const dmUser = allUsers.find(u => u.uid === otherId);
                if (dmUser) {
                    channelName = dmUser.displayName;
                    channelIcon = "fas fa-at";
                }
            }

            return (
                <div className="flex h-screen w-full text-white font-sans overflow-hidden">
                    {showSettings && <UserSettings user={user} currentUserData={currentUserData} onClose={() => setShowSettings(false)} />}
                    
                    {/* SIDEBAR */}
                    <div className="w-64 discord-sidebar flex flex-col border-r border-[#202225] shrink-0">
                        {/* Search Bar / Header */}
                        <div className="h-12 shadow-sm flex items-center px-3 border-b border-[#202225]">
                            <button className="w-full bg-[#202225] text-left text-xs px-2 py-1.5 rounded text-gray-400 hover:text-white transition">
                                Find or start a conversation
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto pt-3 px-2 custom-scrollbar">
                            {/* Global Chat Button */}
                            <div 
                                onClick={() => setActiveChannelId('global')}
                                className={`channel-item flex items-center px-2 py-2 mb-2 rounded cursor-pointer ${activeChannelId === 'global' ? 'active' : 'text-gray-400'}`}
                            >
                                <div className="w-8 h-8 rounded-full bg-[#5865f2] flex items-center justify-center mr-3 text-white">
                                    <i className="fas fa-globe"></i>
                                </div>
                                <span className="font-bold">Global Chat</span>
                            </div>

                            <div className="flex items-center justify-between px-2 mt-4 mb-2">
                                <span className="text-xs font-bold text-gray-400 hover:text-gray-300 uppercase">Direct Messages</span>
                                <i className="fas fa-plus text-gray-400 hover:text-white text-xs cursor-pointer"></i>
                            </div>

                            {/* DM List */}
                            {otherUsers.map(u => {
                                const dmId = getDmId(u.uid);
                                const isActive = activeChannelId === dmId;
                                const { color, icon } = STATUS_MAP[u.status] || STATUS_MAP.online;
                                
                                return (
                                    <div 
                                        key={u.uid} 
                                        onClick={() => setActiveChannelId(dmId)}
                                        className={`channel-item flex items-center p-2 rounded mb-1 cursor-pointer ${isActive ? 'active' : 'text-gray-400'}`}
                                    >
                                        <div className="relative mr-3">
                                            <img src={u.photoURL || "https://cdn.discordapp.com/embed/avatars/0.png"} className="w-8 h-8 rounded-full object-cover" />
                                            <div className={`absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 ${color} border-[3px] border-[#2f3136] rounded-full flex items-center justify-center`}>
                                            </div>
                                        </div>
                                        <div className="overflow-hidden">
                                            <div className={`font-medium truncate ${isActive ? 'text-white' : ''}`}>{u.displayName}</div>
                                            <div className="text-[10px] truncate opacity-60">{u.status}</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* User Panel */}
                        <div className="discord-user-panel p-2 flex items-center justify-between shrink-0">
                            <div className="flex items-center group cursor-pointer hover:bg-[#393c43] p-1 rounded -ml-1 pl-2 pr-4 transition-colors" onClick={() => setShowStatusSetter(!showStatusSetter)}>
                                <div className="relative">
                                    <img src={currentUserData.photoURL || "https://cdn.discordapp.com/embed/avatars/0.png"} className="w-8 h-8 rounded-full object-cover" />
                                    <div className={`absolute bottom-0 right-0 w-3 h-3 ${STATUS_MAP[currentUserData.status]?.color} border-2 border-[#292b2f] rounded-full`}></div>
                                </div>
                                <div className="ml-2">
                                    <div className="text-sm font-bold truncate w-20">{currentUserData.displayName || user.displayName}</div>
                                    <div className="text-xs text-gray-400">#{user.uid.slice(0,4)}</div>
                                </div>
                            </div>
                            {showStatusSetter && <StatusSetter currentStatus={currentUserData.status} onSelectStatus={updateStatus} onClose={() => setShowStatusSetter(false)} />}
                            <div className="flex">
                                <button className="w-8 h-8 flex items-center justify-center rounded hover:bg-[#393c43] text-gray-400 hover:text-white" onClick={() => setShowSettings(true)}>
                                    <i className="fas fa-cog text-sm"></i>
                                </button>
                                <button className="w-8 h-8 flex items-center justify-center rounded hover:bg-[#393c43] text-gray-400 hover:text-white" onClick={() => signOut(auth)}>
                                    <i className="fas fa-sign-out-alt text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CHAT AREA */}
                    <div className="flex-1 flex flex-col bg-[#36393f] min-w-0">
                        {/* Header */}
                        <div className="h-12 discord-header flex items-center px-4 shrink-0 shadow-sm z-10">
                            <i className={`${channelIcon} text-gray-400 text-xl mr-3`}></i>
                            <span className="font-bold text-white mr-auto">{channelName}</span>
                            <div className="flex items-center space-x-4 text-gray-400 text-xl">
                                <i className="fas fa-phone hover:text-white cursor-pointer hidden sm:block"></i>
                                <i className="fas fa-video hover:text-white cursor-pointer hidden sm:block"></i>
                                <i className="fas fa-user-friends hover:text-white cursor-pointer"></i>
                                <div className="bg-[#202225] flex items-center px-2 py-1 rounded text-sm w-36 transition-all focus-within:w-56">
                                    <input type="text" placeholder="Search" className="bg-transparent text-gray-200 w-full focus:outline-none placeholder-gray-500" />
                                    <i className="fas fa-search text-xs ml-1"></i>
                                </div>
                            </div>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar">
                            {messages.length === 0 && (
                                <div className="mt-10 text-center">
                                    <div className="w-20 h-20 bg-[#4f545c] rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-white">
                                        <i className={channelIcon}></i>
                                    </div>
                                    <h3 className="text-3xl font-bold text-white mb-2">Welcome to {channelName}!</h3>
                                    <p className="text-gray-400">This is the start of your conversation.</p>
                                </div>
                            )}

                            {messages.map((msg, i) => {
                                const prev = messages[i-1];
                                const isSame = prev && prev.uid === msg.uid && (msg.createdAt?.seconds - prev.createdAt?.seconds < 300);
                                return (
                                    <div key={msg.id || i} className={`flex pr-4 py-0.5 message-group group ${isSame ? 'mt-0' : 'mt-4'} hover:bg-[#32353b]`}>
                                        <div className="w-[50px] shrink-0 flex justify-center cursor-pointer">
                                            {!isSame ? <img src={msg.photoURL} className="w-10 h-10 rounded-full object-cover mt-0.5 hover:opacity-80" /> : <span className="text-[10px] text-gray-400 hidden group-hover:block mt-1.5">{msg.createdAt?.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            {!isSame && (
                                                <div className="flex items-center">
                                                    <span className="font-medium text-white mr-2 hover:underline cursor-pointer">{msg.displayName}</span>
                                                    <span className="text-xs text-gray-400 mt-0.5">{formatDate(msg.createdAt)}</span>
                                                </div>
                                            )}
                                            <div className="text-gray-300 leading-snug">
                                                {msg.imageUrl ? <img src={msg.imageUrl} className="max-w-md rounded-lg mt-1" /> : (msg.text.includes("media.tenor.com") ? <img src={msg.text} className="max-w-xs rounded-lg mt-1" /> : msg.text)}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={dummyEndRef}></div>
                        </div>

                        {/* Input */}
                        <div className="px-4 pb-6 pt-2 shrink-0">
                            <div className="discord-input flex items-center p-3 rounded-lg">
                                <div className="bg-[#b9bbbe] hover:text-white text-[#2f3136] rounded-full w-6 h-6 flex items-center justify-center cursor-pointer mr-4" onClick={() => fileInputRef.current.click()}>
                                    <i className="fas fa-plus text-xs font-bold"></i>
                                </div>
                                <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                                <form onSubmit={sendMessage} className="flex-1">
                                    <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder={`Message ${activeChannelId === 'global' ? '#general' : '@'+channelName}`} className="w-full bg-transparent text-white focus:outline-none placeholder-gray-500" />
                                </form>
                                <div className="flex items-center space-x-4 mx-2 text-[#b9bbbe]">
                                    <i className="fas fa-gift hover:text-white cursor-pointer" onClick={() => setShowGifPicker(!showGifPicker)}></i>
                                    <i className="fas fa-smile hover:text-white cursor-pointer"></i>
                                </div>
                                {showGifPicker && <GifPicker onSelect={(url) => { sendMessage(null, url); setShowGifPicker(false); }} close={() => setShowGifPicker(false)} />}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>